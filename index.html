<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 5167 Orifice Plate Validation (2003 Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
        }

        .input-group select {
            width: 80px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        #previewPdfBtn {
            background-color: #22d3ee;
            color: white;
            border-radius: 5px;
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .results-section {
            grid-column: 1 / -1;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }

        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .result-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .result-value span:first-child {
            font-weight: 600;
            color: #34495e;
        }

        .validation-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .overall-result {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .hidden {
            display: none;
        }

        /* 3D Visualization Styles */
        .visualization-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        #threeDCanvas {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            background: white;
            cursor: grab;
        }

        #threeDCanvas:active {
            cursor: grabbing;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 500px;
        }

        .view-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 20;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 6px 10px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: #667eea;
            color: white;
        }

        .export-btn {
            padding: 6px 10px;
            background: #27ae60;
            border: 2px solid #27ae60;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #229954;
            border-color: #229954;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr !important;
                padding: 10px !important;
                gap: 15px !important;
            }

            header div[style*="display: flex"] {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            header div[style*="min-width: 300px"] {
                margin-left: 0 !important;
                width: 100% !important;
            }

            .input-group {
                flex-direction: column;
            }

            .input-group input,
            .input-group select {
                width: 100%;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div style="max-width: 1200px; margin: 0 auto; padding: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 24px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="flex-shrink: 0;">
                        <img src="me.png" alt="Ahmed Hussein" class="signature-photo" />
                    </div>
                    <div style="min-width: 250px; text-align: left;">
                        <h3 style="margin: 0 0 6px 0; color: #fff; font-size: 22px; font-weight: 600;">Ahmed Hussein</h3>
                        <p style="margin: 0 0 4px 0; color: #e0f2fe; font-size: 16px; line-height: 1.4;">
                            <strong>Senior Instrumentation and Maintenance Planning Engineer, GASCO</strong>
                        </p>
                        <p style="margin: 0 0 8px 0; color: #cbd5e1; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <strong>Mobile:</strong> 
                            <a href="tel:+201068798889" style="color: #22d3ee; text-decoration: none; font-weight: 500;">+201068798889</a>
                            <a href="https://wa.me/201068798889" target="_blank" rel="noopener noreferrer" style="display: inline-block; text-decoration: none;">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" title="Chat on WhatsApp" style="width: 24px; height: 24px; vertical-align: middle;" />
                            </a>
                        </p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <a href="https://www.linkedin.com/in/ahmedhussein90/" target="_blank" rel="noopener noreferrer" style="display: block; text-decoration: none;">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png" alt="LinkedIn" title="LinkedIn Profile" class="social-icon" />
                            </a>
                            <a href="https://www.credly.com/badges/77121880-e979-459a-b5d4-7c8ee4590614/public_url" target="_blank" rel="noopener noreferrer" style="display: block; text-decoration: none;">
                                <img src="cmrp.png" alt="CMRP Certified" title="CMRP Certification" class="social-icon" />
                            </a>
                            <a href="https://badgr.com/public/assertions/ylnHIYOdQ_62QFhQlnyI6A?identity__email=ahmed.h.abdelaziz%40xed.aucegypt.edu" target="_blank" rel="noopener noreferrer" style="display: block; text-decoration: none;">
                                <img src="f3.jpg" alt="AUC Certificate" title="AUC Certificate of Achievement" class="social-icon" />
                            </a>
                        </div>
                    </div>
                </div>
                <div style="flex: 1; min-width: 300px; text-align: left; margin-left: 0;">
                    <h1 style="margin: 0 0 8px 0; color: #fff;">ISO 5167-2003 Edition <br />Orifice Plate Validation<br /> Complete Validation Tool</h1>
                    <div class="muted" style="color:#e0f2fe"></div>
                </div>
            </div>
        </div>
    </header>

    <style>
        .signature-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #22d3ee;
            box-shadow: 0 4px 12px rgba(34,211,238,0.3);
        }
        .social-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .social-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(34,211,238,0.5);
        }
    </style>

    <div class="container">
        <div class="main-content">
            <!-- Options Section -->
            <div class="section">
                <h3 class="section-title">Options</h3>
                
                <div class="form-group">
                    <label>Unit System:</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="setUnits('SI')">SI (Metric)</button>
                        <button class="toggle-btn" onclick="setUnits('Imperial')">Imperial</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Standard:</label>
                    <select id="standard" disabled>
                        <option value="2003">ISO 5167 2003</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Flatness Method:</label>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="setFlatnessMethod('calculated')">Calculated from Gap</button>
                        <button class="toggle-btn" onclick="setFlatnessMethod('user')">User Entered</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Report Information:</label>
                    <input type="text" id="preparedBy" placeholder="Prepared By">
                </div>
                <div class="form-group">
                    <input type="text" id="tagNumber" placeholder="Tag Number">
                </div>
                <div class="form-group">
                    <input type="text" id="site" placeholder="Site">
                </div>
                <div class="form-group">
                    <input type="text" id="client" placeholder="Client">
                </div>
            </div>
            
            <!-- Inputs Section -->
            <div class="section">
                <h3 class="section-title">Inputs</h3>
                
                <div class="form-group">
                    <label>Meter Tube Bore (D):</label>
                    <div class="input-group">
                        <input type="number" id="meterTubeBore" value="300" step="0.001">
                        <select id="unitD">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Edge Thickness (e):</label>
                    <div class="input-group">
                        <input type="number" id="edgeThickness" value="2" step="0.001">
                        <select id="unitE">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Thickness (E):</label>
                    <div class="input-group">
                        <input type="number" id="thickness" value="10" step="0.001">
                        <select id="unitT">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Angle of Bevel:</label>
                    <div class="input-group">
                        <input type="number" id="angleOfBevel" value="45" step="0.1">
                        <select disabled>
                            <option>Â°</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Roughness (Ra):</label>
                    <div class="input-group">
                        <input type="number" id="roughness" value="0.1" step="0.01">
                        <select id="unitR">
                            <option value="Âµm">Âµm</option>
                            <option value="Âµin">Âµin</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group" id="flatnessGapGroup">
                    <label>Flatness Gap:</label>
                    <div class="input-group">
                        <input type="number" id="flatnessGap" value="0.1" step="0.001">
                        <select id="unitFG">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group hidden" id="flatnessDirectGroup">
                    <label>Flatness (%):</label>
                    <div class="input-group">
                        <input type="number" id="flatnessDirect" value="0.05" step="0.001">
                        <select disabled>
                            <option>%</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Orifice Bore Measurements -->
            <div class="section">
                <h3 class="section-title">Orifice Bore Measurements</h3>
                
                <div class="form-group">
                    <label>Vertical:</label>
                    <div class="input-group">
                        <input type="number" id="vertical" value="150" step="0.001">
                        <select id="unitV">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Right Vertical:</label>
                    <div class="input-group">
                        <input type="number" id="rightVertical" value="149.98" step="0.001">
                        <select id="unitRV">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Horizontal:</label>
                    <div class="input-group">
                        <input type="number" id="horizontal" value="150.02" step="0.001">
                        <select id="unitH">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Left Vertical:</label>
                    <div class="input-group">
                        <input type="number" id="leftVertical" value="149.98" step="0.001">
                        <select id="unitLV">
                            <option value="mm">mm</option>
                            <option value="in">in</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="calculate()">Calculate</button>
                    <button class="btn btn-secondary" onclick="reset()">Reset</button>
                    <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
                    <button class="btn btn-info" id="previewPdfBtn">Preview Kelton Flocalc Validation Report</button>
                </div>
            </div>

            <!-- 3D Visualization Section -->
            <div class="section visualization-section">
                <h3 class="section-title">3D Orifice Plate Visualization</h3>
                <div class="canvas-container">
                    <div class="view-controls">
                        <button class="view-btn" onclick="setView('front')">Front</button>
                        <button class="view-btn" onclick="setView('top')">Top</button>
                        <button class="view-btn" onclick="setView('side')">Side</button>
                        <button class="view-btn" onclick="setView('iso')">Isometric</button>
                        <button class="export-btn" onclick="exportToPNG()">ðŸ“· Export PNG</button>
                    </div>
                    <div id="threeDCanvas"></div>
                </div>
                <p style="text-align: center; margin-top: 10px; color: #7f8c8d; font-size: 14px;">
                    <strong>Interactive 3D Model:</strong> Click and drag to rotate â€¢ Scroll to zoom â€¢ Right-click drag to pan
                </p>
            </div>
            
            <!-- Results Section -->
            <div class="section results-section hidden" id="resultsSection">
                <h3 class="section-title">Validation Results</h3>
                
                <div id="overallResult"></div>
                
                <div class="result-item">
                    <h4>Diameter</h4>
                    <div class="result-value">
                        <span>Orifice Diameter (d):</span>
                        <span id="orificeDiameter"></span>
                    </div>
                    <div class="result-value">
                        <span>Beta Ratio (Î²):</span>
                        <span id="betaRatio"></span>
                    </div>
                    <div class="validation-status" id="diameterStatus"></div>
                </div>
                
                <div class="result-item">
                    <h4>Angle of Bevel</h4>
                    <div class="result-value">
                        <span>Angle of Bevel:</span>
                        <span id="bevelAngle"></span>
                    </div>
                    <div class="validation-status" id="bevelStatus"></div>
                </div>
                
                <div class="result-item">
                    <h4>Thickness</h4>
                    <div class="result-value">
                        <span>Edge Thickness (e):</span>
                        <span id="edgeThicknessResult"></span>
                    </div>
                    <div class="result-value">
                        <span>Thickness (E):</span>
                        <span id="thicknessResult"></span>
                    </div>
                    <div class="validation-status" id="thicknessStatus"></div>
                </div>
                
                <div class="result-item">
                    <h4>Roughness</h4>
                    <div class="result-value">
                        <span>Roughness (Ra):</span>
                        <span id="roughnessResult"></span>
                    </div>
                    <div class="validation-status" id="roughnessStatus"></div>
                </div>
                
                <div class="result-item">
                    <h4>Flatness</h4>
                    <div class="result-value">
                        <span>Flatness:</span>
                        <span id="flatnessResult"></span>
                    </div>
                    <div class="validation-status" id="flatnessStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUnits = 'SI';
        let flatnessMethod = 'calculated';
        let validationResults = {};

        // 3D Visualization Variables
        let scene, camera, renderer, orificePlate, controls;
        let animationId;

        function mmToInch(mm) {
            return mm / 25.4;
        }

        function inchToMm(inch) {
            return inch * 25.4;
        }

        function microMeterToMicroInch(um) {
            return um / 0.0254;
        }

        function microInchToMicroMeter(uin) {
            return uin * 0.0254;
        }

        function setUnits(units) {
            const buttons = document.querySelectorAll('.toggle-group .toggle-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(units)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (units !== currentUnits) {
                convertUnits(currentUnits, units);
                currentUnits = units;
            }
        }

        function convertUnits(from, to) {
            const lengthInputs = ['meterTubeBore', 'edgeThickness', 'thickness', 'flatnessGap',
                                  'vertical', 'rightVertical', 'horizontal', 'leftVertical'];

            lengthInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input && input.value) {
                    const value = parseFloat(input.value);
                    if (from === 'SI' && to === 'Imperial') {
                        input.value = mmToInch(value).toFixed(4);
                    } else if (from === 'Imperial' && to === 'SI') {
                        input.value = inchToMm(value).toFixed(3);
                    }
                }
            });

            const roughnessInput = document.getElementById('roughness');
            if (roughnessInput && roughnessInput.value) {
                const value = parseFloat(roughnessInput.value);
                if (from === 'SI' && to === 'Imperial') {
                    roughnessInput.value = microMeterToMicroInch(value).toFixed(2);
                } else if (from === 'Imperial' && to === 'SI') {
                    roughnessInput.value = microInchToMicroMeter(value).toFixed(2);
                }
            }

            const lengthUnits = ['unitD', 'unitE', 'unitT', 'unitFG', 'unitV', 'unitRV', 'unitH', 'unitLV'];
            lengthUnits.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.value = to === 'SI' ? 'mm' : 'in';
                }
            });

            const roughnessSelect = document.getElementById('unitR');
            if (roughnessSelect) {
                roughnessSelect.value = to === 'SI' ? 'Âµm' : 'Âµin';
            }
        }

        function setFlatnessMethod(method) {
            const buttons = document.querySelectorAll('.toggle-group .toggle-btn');
            buttons[method === 'calculated' ? 2 : 3].classList.add('active');
            buttons[method === 'calculated' ? 3 : 2].classList.remove('active');

            flatnessMethod = method;

            if (method === 'calculated') {
                document.getElementById('flatnessGapGroup').classList.remove('hidden');
                document.getElementById('flatnessDirectGroup').classList.add('hidden');
            } else {
                document.getElementById('flatnessGapGroup').classList.add('hidden');
                document.getElementById('flatnessDirectGroup').classList.remove('hidden');
            }
        }

        function calculate() {
            const D = getValue('meterTubeBore', 'unitD');
            const e = getValue('edgeThickness', 'unitE');
            const E = getValue('thickness', 'unitT');
            const angle = parseFloat(document.getElementById('angleOfBevel').value);
            const Ra = getValue('roughness', 'unitR', true);
            const v = getValue('vertical', 'unitV');
            const rv = getValue('rightVertical', 'unitRV');
            const h = getValue('horizontal', 'unitH');
            const lv = getValue('leftVertical', 'unitLV');

            const d = (v + rv + h + lv) / 4;
            let flatness;

            let flatnessLimit = 0.005 * ((D - d) / 2);
            let flatnessGap = flatnessMethod === 'calculated'
                ? getValue('flatnessGap', 'unitFG')
                : (parseFloat(document.getElementById('flatnessDirect').value) / 100) * ((D - d) / 2);

            let flatnessPercentage = (flatnessGap / ((D - d) / 2)) * 100;

            const beta = d / D;

            let allPass = true;

            let diameterPass = true;
            let diameterMsg = [];

            if (d < 12.5) {
                diameterPass = false;
                diameterMsg.push('FAIL: Orifice diameter < 12.5 mm');
                allPass = false;
            } else {
                diameterMsg.push('Pass, 5.1.8.1: Orifice diameter â‰¥ 12.5 mm');
            }

            if (beta < 0.1 || beta > 0.75) {
                diameterPass = false;
                diameterMsg.push('FAIL: 0.1 â‰¤ Î² â‰¤ 0.75 not satisfied');
                allPass = false;
            } else {
                diameterMsg.push('Pass, 5.1.8.1: 0.1 â‰¤ Î² â‰¤ 0.75');
            }

const diameters = [v, rv, h, lv];
const maxDev = Math.max(...diameters.map(val => Math.abs((val - d) / d * 100)));
if (maxDev > 0.05) {
    diameterPass = false;
    diameterMsg.push('FAIL, 5.1.8.3: No mean diameter shall differ by more than 0.05 % from the mean diameter');
    allPass = false;
} else {
    diameterMsg.push('Pass, 5.1.8.3: No mean diameter shall differ by more than 0.05 % from the mean diameter');
}


            const bevelPass = angle >= 30 && angle <= 60;
            const bevelMsg = bevelPass ? 
                'Pass, 5.1.6.2: The angle of bevel shall be 45Â° Â± 15Â°' : 
                'FAIL: Angle must be 45Â° Â± 15Â°';
            if (!bevelPass) allPass = false;

            let thicknessPass = true;
            let thicknessMsg = [];

            if (e >= 0.005 * D && e <= 0.02 * D) {
                thicknessMsg.push('Pass, 5.1.5.1: 0.005D â‰¤ e â‰¤ 0.02D');
            } else {
                thicknessPass = false;
                thicknessMsg.push('FAIL: 0.005D â‰¤ e â‰¤ 0.02D not satisfied');
                allPass = false;
            }

            if (E >= e && E <= 0.05 * D) {
                thicknessMsg.push('Pass, 5.1.5.3: e â‰¤ E â‰¤ 0.05D');
            } else {
                thicknessPass = false;
                thicknessMsg.push('FAIL: e â‰¤ E â‰¤ 0.05D not satisfied');
                allPass = false;
            }

            const roughnessLimit = 0.0001 * d;
            const roughnessPass = Ra < roughnessLimit;
            const roughnessMsg = roughnessPass ? 
                `Pass, 5.1.3.2: Ra < 0.0001d (limit: ${(roughnessLimit * 1000).toFixed(2)} Âµm)` : 
                `FAIL: Ra must be < 0.0001d (limit: ${(roughnessLimit * 1000).toFixed(2)} Âµm)`;
            if (!roughnessPass) allPass = false;

            const flatnessLimitPercent = 0.5;
            const flatnessPass = flatnessPercentage <= flatnessLimitPercent;
            const flatnessMsg = flatnessPass ? 
                'Pass, 5.1.3.1: Gradient across plate must be less than 0.5% at all points' : 
                'FAIL: Flatness exceeds 0.5% gradient limit';
            if (!flatnessPass) allPass = false;

            validationResults = {
                D, e, E, angle, Ra, flatness, flatnessPercentage, d, beta,
                diameterPass, bevelPass, thicknessPass, roughnessPass, flatnessPass, allPass,
                diameterMsg, bevelMsg, thicknessMsg, roughnessMsg, flatnessMsg
            };

            displayResults();
            
            if (scene) {
                update3DModel();
            }
        }

        function getValue(inputId, unitSelectId, isRoughness = false) {
            const input = document.getElementById(inputId);
            const unitSelect = document.getElementById(unitSelectId);
            const value = parseFloat(input.value);
            const unit = unitSelect.value;

            if (isRoughness) {
                return unit === 'Âµm' ? value / 1000 : microInchToMicroMeter(value) / 1000;
            } else {
                return unit === 'mm' ? value : inchToMm(value);
            }
        }

        function displayResults() {
            const r = validationResults;
            const unitLabel = currentUnits === 'SI' ? 'mm' : 'in';
            const roughnessUnit = currentUnits === 'SI' ? 'Âµm' : 'Âµin';

            const displayD = currentUnits === 'SI' ? r.D : mmToInch(r.D);
            const displayd = currentUnits === 'SI' ? r.d : mmToInch(r.d);
            const displaye = currentUnits === 'SI' ? r.e : mmToInch(r.e);
            const displayE = currentUnits === 'SI' ? r.E : mmToInch(r.E);
            const displayFlatness = currentUnits === 'SI' ? r.flatness : mmToInch(r.flatness);
            const displayRa = currentUnits === 'SI' ? r.Ra * 1000 : microMeterToMicroInch(r.Ra * 1000);

            document.getElementById('resultsSection').classList.remove('hidden');
            const overallDiv = document.getElementById('overallResult');
            overallDiv.className = 'overall-result ' + (r.allPass ? 'status-pass' : 'status-fail');
            overallDiv.textContent = r.allPass ? 
                'PASS - Orifice plate validated against ISO 5167 criteria' : 
                'FAIL - Orifice plate does not meet ISO 5167 criteria';

            document.getElementById('orificeDiameter').textContent = `${displayd.toFixed(currentUnits === 'SI' ? 3 : 4)} ${unitLabel}`;
            document.getElementById('betaRatio').textContent = r.beta.toFixed(6);
            const diameterStatus = document.getElementById('diameterStatus');
            diameterStatus.className = 'validation-status ' + (r.diameterPass ? 'status-pass' : 'status-fail');
            diameterStatus.innerHTML = r.diameterMsg.join('<br>');

            document.getElementById('bevelAngle').textContent = `${r.angle}Â°`;
            const bevelStatus = document.getElementById('bevelStatus');
            bevelStatus.className = 'validation-status ' + (r.bevelPass ? 'status-pass' : 'status-fail');
            bevelStatus.textContent = r.bevelMsg;

            document.getElementById('edgeThicknessResult').textContent = `${displaye.toFixed(currentUnits === 'SI' ? 3 : 4)} ${unitLabel}`;
            document.getElementById('thicknessResult').textContent = `${displayE.toFixed(currentUnits === 'SI' ? 3 : 4)} ${unitLabel}`;
            const thicknessStatus = document.getElementById('thicknessStatus');
            thicknessStatus.className = 'validation-status ' + (r.thicknessPass ? 'status-pass' : 'status-fail');
            thicknessStatus.innerHTML = r.thicknessMsg.join('<br>');

            document.getElementById('roughnessResult').textContent = `${displayRa.toFixed(currentUnits === 'SI' ? 2 : 1)} ${roughnessUnit}`;
            const roughnessStatus = document.getElementById('roughnessStatus');
            roughnessStatus.className = 'validation-status ' + (r.roughnessPass ? 'status-pass' : 'status-fail');
            roughnessStatus.textContent = r.roughnessMsg;

            document.getElementById('flatnessResult').textContent = `${r.flatnessPercentage.toFixed(3)}%`;
            const flatnessStatus = document.getElementById('flatnessStatus');
            flatnessStatus.className = 'validation-status ' + (r.flatnessPass ? 'status-pass' : 'status-fail');
            flatnessStatus.textContent = r.flatnessMsg;

            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function reset() {
            document.getElementById('meterTubeBore').value = 300;
            document.getElementById('edgeThickness').value = 2;
            document.getElementById('thickness').value = 10;
            document.getElementById('angleOfBevel').value = 45;
            document.getElementById('roughness').value = 0.1;
            document.getElementById('flatnessGap').value = 0.1;
            document.getElementById('flatnessDirect').value = 0.05;
            document.getElementById('vertical').value = 150;
            document.getElementById('rightVertical').value = 149.98;
            document.getElementById('horizontal').value = 150.02;
            document.getElementById('leftVertical').value = 149.98;
            document.getElementById('preparedBy').value = '';
            document.getElementById('tagNumber').value = '';
            document.getElementById('site').value = '';
            document.getElementById('client').value = '';

            document.getElementById('resultsSection').classList.add('hidden');
            validationResults = {};
        }

        function exportToExcel() {
            if (!validationResults.d) {
                alert('Please calculate results first before exporting.');
                return;
            }

            const r = validationResults;
            const date = new Date().toLocaleDateString('en-CA');
            const time = new Date().toLocaleTimeString();

            const getDisplayValue = (inputId, unitId) => {
                const value = parseFloat(document.getElementById(inputId).value);
                const unit = document.getElementById(unitId).value;
                const decimals = unit === 'in' ? 4 : 3;
                return `${value.toFixed(decimals)} ${unit}`;
            };

            const getDisplayRoughness = () => {
                const value = parseFloat(document.getElementById('roughness').value);
                const unit = document.getElementById('unitR').value;
                const decimals = unit === 'Âµin' ? 1 : 2;
                return `${value.toFixed(decimals)} ${unit}`;
            };

            const getDisplayFlatness = () => {
                if (flatnessMethod === 'calculated') {
                    const gap = parseFloat(document.getElementById('flatnessGap').value);
                    const unit = document.getElementById('unitFG').value;
                    const decimals = unit === 'in' ? 4 : 3;
                    return `${gap.toFixed(decimals)} ${unit} (gap)`;
                } else {
                    const percent = parseFloat(document.getElementById('flatnessDirect').value);
                    return `${percent.toFixed(3)}%`;
                }
            };

            const wb = XLSX.utils.book_new();

            const data = [
                ['ISO 5167 Orifice Plate Validation Report', '', ''],
                ['Date:', date, `Time: ${time}`],
                ['Prepared By:', document.getElementById('preparedBy').value, `Site: ${document.getElementById('site').value}`],
                ['Tag Number:', document.getElementById('tagNumber').value, `Client: ${document.getElementById('client').value}`],
                ['Standard:', 'ISO 5167-2:2003', ''],
                ['', '', ''],
                ['INPUTS', 'Value', ''],
                ['Meter tube bore (D)', getDisplayValue('meterTubeBore', 'unitD'), ''],
                ['Edge thickness (e)', getDisplayValue('edgeThickness', 'unitE'), ''],
                ['Plate thickness (E)', getDisplayValue('thickness', 'unitT'), ''],
                ['Angle of bevel', `${document.getElementById('angleOfBevel').value}Â°`, ''],
                ['Roughness (Ra)', getDisplayRoughness(), ''],
                ['Flatness', getDisplayFlatness(), ''],
                ['', '', ''],
                ['ORIFICE BORE MEASUREMENTS', 'Value', ''],
                ['Vertical', getDisplayValue('vertical', 'unitV'), ''],
                ['Right vertical', getDisplayValue('rightVertical', 'unitRV'), ''],
                ['Horizontal', getDisplayValue('horizontal', 'unitH'), ''],
                ['Left vertical', getDisplayValue('leftVertical', 'unitLV'), ''],
                ['', '', ''],
['VALIDATION RESULTS', 'Value', 'Status'],
['Orifice diameter (d)', document.getElementById('orificeDiameter').textContent, r.diameterMsg[0]],
['Beta ratio (Î²)', r.beta.toFixed(6), r.diameterMsg[1] || ''],
['Diameter deviation check', '', ' r.diameterMsg[2] || ''],
['Angle of bevel', `${r.angle.toFixed(1)}Â°`, r.bevelMsg],
                ['Edge thickness', document.getElementById('edgeThicknessResult').textContent, r.thicknessMsg[0]],
                ['Plate thickness', document.getElementById('thicknessResult').textContent, r.thicknessMsg[1] || ''],
                ['Roughness', document.getElementById('roughnessResult').textContent, r.roughnessMsg],
                ['Flatness', document.getElementById('flatnessResult').textContent, r.flatnessMsg],
                ['', '', ''],
                ['OVERALL RESULT', r.allPass ? 'PASS' : 'FAIL', r.allPass ? 'âœ“ Validated against ISO 5167-2:2003' : 'âœ— Does not meet requirements']
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);

            ws['!cols'] = [
                {wch: 30},
                {wch: 20},
                {wch: 60}
            ];

            ws['!margins'] = {
                left: 0.5, right: 0.5,
                top: 0.5, bottom: 0.5,
                header: 0.3, footer: 0.3
            };

            ws['!print'] = {
                orientation: 'portrait',
                scale: 100,
                fitToPage: true,
                fitToWidth: 1,
                fitToHeight: 1
            };

            XLSX.utils.book_append_sheet(wb, ws, 'ISO 5167 Validation');

            const tagNum = document.getElementById('tagNumber').value || 'Report';
            const filename = `ISO-5167-Validation-${tagNum}-${date}.xlsx`;

            XLSX.writeFile(wb, filename);
        }

        document.getElementById('previewPdfBtn').addEventListener('click', function() {
            const pdfUrl = './ISO 5167 Orifice Plate Validation - Kelton Flocalc.pdf';
            window.open(pdfUrl, '_blank', 'fullscreen=yes');
        });

        // ========== 3D VISUALIZATION CODE ==========

        function init3DVisualization() {
            const container = document.getElementById('threeDCanvas');
            if (!container) return;

            if (renderer) {
                renderer.dispose();
                container.innerHTML = '';
            }

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 10000);
            camera.position.set(300, 200, 400);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.minDistance = 100;
            controls.maxDistance = 1500;
            controls.maxPolarAngle = Math.PI;

            // Reduced lighting for less bright appearance
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight1.position.set(200, 300, 200);
            directionalLight1.castShadow = true;
            directionalLight1.shadow.mapSize.width = 2048;
            directionalLight1.shadow.mapSize.height = 2048;
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.25);
            directionalLight2.position.set(-200, 200, -200);
            scene.add(directionalLight2);

            const directionalLight3 = new THREE.DirectionalLight(0xffffff, 0.2);
            directionalLight3.position.set(0, -200, 100);
            scene.add(directionalLight3);

            window.addEventListener('resize', onWindowResize, false);

            update3DModel();
            animate();
        }

        function createOrificePlate() {
            const D = getValue('meterTubeBore', 'unitD');
            const d_measurements = [
                getValue('vertical', 'unitV'),
                getValue('rightVertical', 'unitRV'),
                getValue('horizontal', 'unitH'),
                getValue('leftVertical', 'unitLV')
            ];
            const d = d_measurements.reduce((a, b) => a + b, 0) / 4;
            const e = getValue('edgeThickness', 'unitE');
            const E = getValue('thickness', 'unitT');
            const bevelAngle = parseFloat(document.getElementById('angleOfBevel').value);

            if (orificePlate) {
                scene.remove(orificePlate);
                orificePlate.traverse((child) => {
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) child.material.dispose();
                });
            }

            orificePlate = new THREE.Group();

            const steelMaterial = new THREE.MeshStandardMaterial({
                color: 0x8c9199,
                metalness: 0.9,
                roughness: 0.3,
                envMapIntensity: 1.0
            });

            const edgeMaterial = new THREE.MeshStandardMaterial({
                color: 0xa8b0b8,
                metalness: 0.85,
                roughness: 0.4
            });

            const outerRadius = D / 2;
            const innerRadius = d / 2;
            
            const plateGeometry = new THREE.CylinderGeometry(outerRadius, outerRadius, E, 64);
            const plateMesh = new THREE.Mesh(plateGeometry, steelMaterial);
            plateMesh.castShadow = true;
            plateMesh.receiveShadow = true;
            orificePlate.add(plateMesh);

            // Create the bore hole with WHITE color
            const boreGeometry = new THREE.CylinderGeometry(innerRadius, innerRadius, E + 2, 64);
            const boreMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                opacity: 1,
                transparent: false,
                side: THREE.DoubleSide,
                metalness: 0,
                roughness: 1
            });
            const boreMesh = new THREE.Mesh(boreGeometry, boreMaterial);
            orificePlate.add(boreMesh);

            const edgeRingGeometry = new THREE.CylinderGeometry(
                innerRadius + 0.1,
                innerRadius,
                e,
                64
            );
            const edgeRing = new THREE.Mesh(edgeRingGeometry, edgeMaterial);
            edgeRing.position.y = E / 2 - e / 2;
            orificePlate.add(edgeRing);

            const bevelRadiusTop = innerRadius;
            const bevelRadiusBottom = innerRadius + (E - e) * Math.tan((bevelAngle * Math.PI) / 180);
            const bevelHeight = E - e;
            
            const bevelGeometry = new THREE.CylinderGeometry(
                bevelRadiusBottom,
                bevelRadiusTop,
                bevelHeight,
                64
            );
            const bevelMesh = new THREE.Mesh(bevelGeometry, edgeMaterial);
            bevelMesh.position.y = -e / 2;
            orificePlate.add(bevelMesh);

            addDimensionLines(D, d, E, e);

            scene.add(orificePlate);
        }

        function addDimensionLines(D, d, E, e) {
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x667eea, linewidth: 2 });
            
            const outerDiamPoints = [];
            outerDiamPoints.push(new THREE.Vector3(-D / 2, E / 2 + 20, 0));
            outerDiamPoints.push(new THREE.Vector3(D / 2, E / 2 + 20, 0));
            const outerDiamGeometry = new THREE.BufferGeometry().setFromPoints(outerDiamPoints);
            const outerDiamLine = new THREE.Line(outerDiamGeometry, lineMaterial);
            orificePlate.add(outerDiamLine);

            const markerGeometry = new THREE.CylinderGeometry(1, 1, 15, 8);
            const markerMaterial = new THREE.MeshBasicMaterial({ color: 0x667eea });
            
            const marker1 = new THREE.Mesh(markerGeometry, markerMaterial);
            marker1.position.set(-D / 2, E / 2 + 20, 0);
            marker1.rotation.z = Math.PI / 2;
            orificePlate.add(marker1);
            
            const marker2 = new THREE.Mesh(markerGeometry, markerMaterial);
            marker2.position.set(D / 2, E / 2 + 20, 0);
            marker2.rotation.z = Math.PI / 2;
            orificePlate.add(marker2);

            const innerDiamPoints = [];
            innerDiamPoints.push(new THREE.Vector3(-d / 2, E / 2 + 40, 0));
            innerDiamPoints.push(new THREE.Vector3(d / 2, E / 2 + 40, 0));
            const innerDiamGeometry = new THREE.BufferGeometry().setFromPoints(innerDiamPoints);
            const innerDiamLine = new THREE.Line(innerDiamGeometry, lineMaterial);
            orificePlate.add(innerDiamLine);

            const marker3 = new THREE.Mesh(markerGeometry, markerMaterial);
            marker3.position.set(-d / 2, E / 2 + 40, 0);
            marker3.rotation.z = Math.PI / 2;
            orificePlate.add(marker3);
            
            const marker4 = new THREE.Mesh(markerGeometry, markerMaterial);
            marker4.position.set(d / 2, E / 2 + 40, 0);
            marker4.rotation.z = Math.PI / 2;
            orificePlate.add(marker4);

            const thicknessPoints = [];
            thicknessPoints.push(new THREE.Vector3(D / 2 + 30, -E / 2, 0));
            thicknessPoints.push(new THREE.Vector3(D / 2 + 30, E / 2, 0));
            const thicknessGeometry = new THREE.BufferGeometry().setFromPoints(thicknessPoints);
            const thicknessLine = new THREE.Line(thicknessGeometry, lineMaterial);
            orificePlate.add(thicknessLine);

            const marker5 = new THREE.Mesh(markerGeometry, markerMaterial);
            marker5.position.set(D / 2 + 30, -E / 2, 0);
            orificePlate.add(marker5);
            
            const marker6 = new THREE.Mesh(markerGeometry, markerMaterial);
            marker6.position.set(D / 2 + 30, E / 2, 0);
            orificePlate.add(marker6);

            addTextLabel(`D = ${D.toFixed(2)} mm`, 0, E / 2 + 30, 0);
            addTextLabel(`d = ${d.toFixed(2)} mm`, 0, E / 2 + 50, 0);
            addTextLabel(`E = ${E.toFixed(2)} mm`, D / 2 + 50, 0, 0);
        }

        function addTextLabel(text, x, y, z) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            
            context.fillStyle = 'rgba(255, 255, 255, 0.95)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            context.strokeStyle = '#667eea';
            context.lineWidth = 2;
            context.strokeRect(2, 2, canvas.width - 4, canvas.height - 4);
            
            context.fillStyle = '#2c3e50';
            context.font = 'bold 24px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, canvas.width / 2, canvas.height / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            
            sprite.position.set(x, y, z);
            sprite.scale.set(60, 15, 1);
            
            orificePlate.add(sprite);
        }

        function update3DModel() {
            createOrificePlate();
        }

        function animate() {
            animationId = requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('threeDCanvas');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function setView(view) {
            switch(view) {
                case 'front':
                    camera.position.set(0, 0, 400);
                    break;
                case 'top':
                    camera.position.set(0, 400, 0);
                    break;
                case 'side':
                    camera.position.set(400, 0, 0);
                    break;
                case 'iso':
                    camera.position.set(300, 200, 400);
                    break;
            }
            camera.lookAt(0, 0, 0);
            controls.update();
        }

        function exportToPNG() {
            if (!renderer) {
                alert('3D model not initialized yet. Please wait for the model to load.');
                return;
            }

            try {
                renderer.render(scene, camera);
                
                const canvas = renderer.domElement;
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const tagNum = document.getElementById('tagNumber').value || 'Orifice-Plate';
                    const date = new Date().toISOString().split('T')[0];
                    link.download = `${tagNum}-3D-Model-${date}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png');
            } catch (error) {
                console.error('Error exporting PNG:', error);
                alert('Error exporting image. Please try again.');
            }
        }

        window.addEventListener('load', function() {
            init3DVisualization();
        });
    </script>
</body>
</html>

